# 4. 스트림 소개

## 4.1 스트림이란 무엇인가?
스트림은 자바 8 API에 새로 추가된 기능으로, 스트림을 사용하면 선언형으로 컬렉션 데이터를 처리할 수 있다. 또한 스트림을 이용하면 멀티스레드 코드를 구현하지 않아도 데이터를 투명하게 병렬로 처리할 수 있다.

`filter` 같은 연산은 고수준 빌딩 블록으로 이루어져 있으므로 특정 스레딩 모델에 제한되지 않고 자유롭게 어떤 상황에서든 사용할 수 있다. 결과적으로 우리는 데이터 처리 과정을 병렬화하면서 스레드와 락을 걱정할 필요가 없다.

자바 8의 스트림 API의 특징을 요약하면 아래와 같다.
- 선언형: 더 간결하고 가독성이 좋아짐
- 조립할 수 있음: 유연성이 좋아짐
- 병렬화: 성능이 좋아짐

## 4.2 스트림 시작하기
자바 8 컬렉션에는 스트림을 반환하는 `stream`메서드가 추가됐다.

스트림이란 '데이터 처리 연산을 지원하도록 소스에서 추출된 연속된 요소'로 정의할 수 있다.
- 연속된 요소: 컬렉션과 마찬가지로 스트림은 특정 요소 형식으로 이루어진 연속된 값 집합의 인터페이스를 제공한다. 컬렉션의 주제는 데이터고, 스트림의 주제는 계산이다.
- 소스: 스트림은 컬렉션, 배열, I/O 자원 등의 데이터 제공 소스로부터 데이터를 소비한다.
- 데이터 처리 연산: 스트림은 함수형 프로그래밍 언어에서 일반적으로 지원하는 연산과 데이터베이스와 비슷한 연산을 지원한다.
- 파이프라이닝: 대부분의 스트림 연산은 스트림 연산끼리 연결해서 커다란 파이프라인을 구성할 수 있도록 스트림 자신을 반환한다. 그 덕분에 laziness, short-circuiting 같은 최적화도 얻을 수 있다. 연산 파이프라인은 데이터 소스에 적용하는 데이터베이스 질의와 비슷하다.
- 내부 반복: 반복자를 이용해서 명시적으로 반복하는 컬렉션과 달리 스트림은 내부 반복을 지원한다.

## 4.3 스트림과 컬렉션
자바의 기존 컬렉션과 새로운 스트림 모두 연속된 요소 형식의 값을 저장하는 자료구조의 인터페이스를 제공한다. 여기서 '연속된'이라는 표현은 순서와 상관없이 아무 값에나 접근하는 것이 아니라 순차적으로 값에 접근한다는 것을 의미한다.

데이터를 '언제' 계산하느냐가 컬렉션과 스트림의 가장 큰 차이다. 컬렉션은 현재 자료구조가 포함하는 모든 값을 메모리에 저장하는 자료구조다. 즉, 컬렉션의 모든 요소는 컬렉션에 추가하기 전에 계산되어야 한다.

반면 스트림은 이론적으로 '요청할 때만 요소를 계산'하는 고정된 자료구조다. (스트림에 요소를 추가하거나 제거할수 없음) 이러한 스트림의 특성은 프로그래밍에 큰 도움을 준다. 결과적으로 스트림은 생산자와 소비자 관계를 형성한다. 또한 스트림은 게으르게 만들어지는 컬렉션과 같다. 즉, 사용자가 데이터를 요청할 때만 값을 계산한다.

### 딱 한 번만 탐색할 수 있다
탐색된 스트림의 요소는 소비된다. 반복자와 마찬가지로 한 번 탐색한 요소를 다시 탐색하려면 초기 데이터 소스에서 새로운 스트림을 만들어야 한다.

### 외부 반복과 내부 반복
컬렉션 인터페이스를 사용하려면 사용자가 직접 요소를 반복해야 한다(for-each 등을 사용해서). 이를 외부 반복이라고 한다. 반면 스트림 라이브러리는 (반복을 알아서 처리하고 결과 스트림 값을 어딘가에 저장해주는) 내부 반복을 사용한다. 함수에 어떤 작업을 수행할지만 지정하면 모든것이 알아서 처리된다.

내부 반복을 이용하면 작업을 투명하게 병렬로 처리하거나 더 최적화된 다양한 순서로 처리할 수 있다.

## 4.4 스트림 연산
스트림 인터페이스의 연산은 크게 두 가지로 구분할 수 있다.

- 중간연산: 연결할 수 있는 스트림 연산
- 최종연산: 스트림을 닫는 연산

### 중간 연산
`filter`나 `sorted` 같은 중간 연산은 다른 스트림을 반환하므로 여러 중간 연산을 연결해서 질의를 만들 수 있다. 중간 연산의 중요한 특징은 단말 연산을 스트림 파이프라인에 실행하기 전까지는 아무도 연산을 수행하지 않는다는 것이다. 즉, lazy하다는 것이다. 중간 연산을 합친 다음에 합쳐진 중간 연산을 최종 연산으로 한 번에 처리하기 때문이다.

### 최종 연산
최종 연산은 스트림 파이프라인에서 결과를 도출한다. 보통 최종 연산에 의해 스트림 이외의 결과가 반환된다.

### 스트림 이용하기
스트림 파이프라인의 개념은 빌더 패턴과 비슷하다. 빌더 패턴에서는 호출을 연결해서 설정을 만든다(중간 연산 연결). 그리고 준비된 설정에 `build` 메서드를 호출(최종 연산)한다.

# 5. 스트림 활용
## 5.1 필터링
### 프레디케이트로 필터링
스트림 인터페이스는 `filter` 메서드를 지원한다. `filter` 메서드는 프레디케이트(불리언을 반환하는 함수)를 인수로 받아서 프레디케이트와 일치하는 모든 요소를 포함하는 스트림을 반환한다.

### 고유 요소 필터링
스트림은 고유 요소로 이루어진 스트림을 반환하는 `distinct` 메서드도 지원한다.

## 5.2 스트림 슬라이싱
### 프레디케이트를 이용한 슬라이싱
자바 9는 스트림의 요소를 효과적으로 선택할 수 있도록 `takeWhile`, `dropWhile` 두 가지 새로운 메서드를 지원한다.

`takeWhile`을 이용하면 무한 스트림을 포함한 모든 스트림에 프레디케이트를 적용해 스트림을 슬라이스 할 수 있다. `dropWhile`은 `takeWhile`과 정반대의 작업을 수행한다. `dropWhile`은 프레디케이트가 처음으로 거짓이 되는 지점까지 발견된 요소를 버린다.

## 5.3 매핑
스트림 API의 `map`과 `faltMap` 메서드는 특정 데이터를 선택하는 기능을 제공한다.

### 스트림의 각 요소에 함수 적용하기
스트림은 함수를 인수로 받는 `map` 메서드를 지원한다. 인수로 제공된 함수는 각 요소에 적용되며 함수를 적용한 결과가 새로운 요소로 매핑된다.

### 스트림의 평면화
`flatMap`메서드는 스트림의 각 값을 다른 스트림으로 만든 다음에 모든 스트림을 하나의 스트림으로 연결하는 기능을 수행한다.

## 5.4 검색과 매칭
스트림 API는 `allMatch`, `anyMatch`, `noneMatch`, `findFirst`, `findAny` 등 다양한 유틸리티 메서드를 제공한다.
> 때로는 전체 스트림을 처리하지 않았더라도 결과를 반환할 수 있다. 이러한 상황을 쇼트 서킷이라고 부른다. allMatch, nonMatch, findFirst, findAny 등의 연산은 모든 스트림의 요소를 처리하지 않고도 결과를 반환할 수 있다.

> `findFirst`와 `findAny`메서드가 모두 필요한 이유는 병렬성 때문이다. 병렬 실행에서는 첫 번재 요소를 찾기 어려우므로 요소의 반환 순서가 상관 없다면 병렬 스트림에서는 제약이 적은 `findAny`를 사용한다.

## 5.5 리듀싱
리듀싱 연산이란 모든 스트림 요소를 처리해서 값으로 도출하는 연산을 말한다. 

`reduce`를 이용하면 내부 반복이 추상화되면서 내부 구현에서 병렬로 reduce를 실행할 수 있게 된다. 

### 기본형 특화 스트림
자바 8에서는 세 가지 기본형 특화 스트림을 제공한다. 스트림 API는 박싱 비용을 피할 수 있도록 기본형 요소에 특화된 스트림을 제공한다. 특화 스트림은 오직 박싱 과정에서 일어나는 효율성과 관련 있으며 스트림에 추가 기능을 제공하지 않는다.

