# 7. 데이터 암호화

MySQL 8.0으로 업그레이드되면서 데이터 파일 뿐만 아니라 리두 로그나 언두 로그, 복제를 위한 바이너리 로그 등도 모두 암호화 기능을 지원하기 시작했다.

응용 프로그램에서 암호화한 데이터를 데이터베이스 서버에서 다시 암호화하는 이중 암호화 방법을 선택하기도 한다. 응용 프로그램의 암호화는 주로 중요 정보를 가진 컬럼 단위로 암호화를 수행하며, 데이터베이스 수준에서는 테이블 단위로 암호화를 적용한다.

## 7.1 MySQL 서버의 데이터 암호화
데이터베이스 서버와 디스크 사이의 데이터를 읽고 쓰기 지점에서 암호화 또는 복호화를 수행한다.

MySQL 서버(InnoDB 스토리지 엔진)의 I/O레이어에서만 데이터의 암호화 및 복호화 과정이 실행된다.

MySQL 서버의 암호화 방식을 TDE(Transparent Data Encryption)이라고 하며, `Data at Rest Encryption`라고도 하는데, `Data at Rest`는 메모리(In-Process)나 네트워크 전송(In-
Transit)단계가 아닌 디스크에 저장(At Rest)된 단계에서만 암호화된다는 의미로 사용되는 표현이다.

### 2단계 키 관리
MySQL 서버의 데이터 암호화는 마스터 키(master key)와 테이블스페이스 키(tablespace key 또는 프라이빗 키 private key) 두 가지 종류의 키를 가지고 있다.

마스터키는 외부 키 관리 솔루션 또는 디스크의 파일(keyring_file 또는 keyring_cencrypted_file 플러그인 사용)에서 가져온다.

테이블스페이스 키는 암호화된 테이블이 생성될 대마다 해당 테이블을 위한 임의의 테이블스페이스 키를 발급하고, 마스터 키를 이용해 테이블스페이스 키를 암호화해서 각 테이블의 데이터 파일 헤더에 저장한다.

테이블스페이스 키는 테이블이 삭제되지 않는 이상 절대 변경되지 않으며 서버 외부로 절대 노출되지 않는다. 하지만 마스터 키는 외부의 파일을 이용하기 때문에 노출될 가능성이 있으므로 주기적으로 변경해야 한다.

### 암호화와 성능
TDE 방식을 사용하기 때문에 디스크로부터 한 번 읽은 데이터 페이지는 복호화되어 InnoDB 버퍼 풀에 적재되기 때문에 데이터 페이지가 한 번 메모리에 적재되면 암호화되지 않은 테이블과 동일한 성능을 보인다.

쿼리가 InnoDB 버퍼 풀에 존재하지 않는 데이터 페이지를 읽어야 할 경우에는 복호화 과정을 거치기 때문에 복호화 시간 동안 쿼리 처리가 지연된다.

## 7.3 테이블 암호화
암호화된 테이블 생성은 일반적인 테이블 생성 구문과 동일하며, 마지막에 `ENCRYPTION='Y'`옵션만 추가로 넣으면 된다. 그러면 이제부터 이 테이블의 데이터가 디스크에 기록될 때 데이터가 자동으로 암호화되어 저장되고, 다시 디스크에서 메모리로 읽어올 때 복호화된다.

MySQL 서버의 모든 테이블에 대해 암호화를 적용하고자 한다면 `default_table_encrytion` 시스템 변수를 `ON`으로 설정하면 옵션을 별도로 설정하지 않아도 암호화된 테이블로 생성된다.


